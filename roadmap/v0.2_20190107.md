# v0.2 2019 week?

MINimal imaGe보다는 BOX-Engine에 더 가까워진 느낌이라서 이름변경도 고민


## 기능

### 기본 env

USER_HOME \
  docker 이미지별 user home dir

WORK_ROOT \
  설정파일에 있는 application root dir

### trigger(v0.3)
cron, webhook.. 등으로 volume 청소 소스클린, 빌드 등등..

### 공유 volume
1. group volume - 사용자 그룹 또는 팀단위
2. user volume - 사용자별 서비스가 되면?? 일단 불필요
3. project volume - 프로젝트 생성시 만들어지고 수동삭제 안하면 유지
4. tmp volume - 매 프로세스 동작시 생성 후 삭제

같은 프로젝트 내에서 volume 이름은 unique

box 사이에서 값을 공유할 때 사용\
`ex) npm_modules, .m2, ....)`

#### group volume
`grp-${group_name}-${volume_name}` (unique)

```yaml
volume_cache:
  grp:
      {volume_name_unique}: {default_mount_path}
      m2: $USER_HOME/.m2
      npm_g: /usr/local/lib/node_modules
    #  nvm_g: $USER_HOME/.nvm/versions/node/v10.14.1/lib/node_modules
      nvm_g: $USER_HOME/.nvm/versions/node/$node_version/lib/node_modules
  usr:
    ....
```

#### user volume
`usr-${user_name}_${volume_name}` (unique)

```yaml
volume_cache:
  usr:
    # error! name duplicated with global npm_g.
    # volume name in system is different but logically duplicate in MinG
    npm_g: /usr/local/lib/node_modules
    myenv: $USER_HOME/env
```

#### project volume
`prj-${project_name}-${volume_name}` (unique)

```yaml
volume_cache:
  prj:
    npm: ${USER_HOME}/app/node_modules
......
```

#### tmp volume
`tmp-${project_name}-${volume_name}` (unique)
매 프로세스 동작시 생성 후 제거

```yaml
volume_cache:
  tmp:
    app: ${USER_HOME}/app
```

### ENV 저장(v0.3)
etcd, db. .... 

credential 저장시 암호화 기능
나중에 고민 필요

```dotenv
mysql_username=xxxxxxxxxxxxxxxxxx
mysql_password=xxxxxxxxxxxxxxxxxxx
redis_secret=xxxxxxxxxxxxxxxxxxx
```

### 단계별 box 구조
1. build with build-arg
   * Image 있는거사용
   * Dockerfile 이용 빌드
   * github 호환박스 주소로 사용
2. run with env
3. volume
4. run tty 정의되는 기능 순차적으로 실행 default single
(shell 환경은 multi thread 실행하면 오류가능성이 커서)
command[]
copy in[]
copy out[]
5. file extract - and stay tmp

dockerfile 이용해서 빌드
```yaml
volume_cache:
  prj:
    m2: $USER_HOME/.m2
    npm: ${USER_HOME}/app/node_modules
  tmp:
    pass_jar: # no default
    pass_front:

# git only
# volume - rep
# life cycle linked with project
# rep-${project_name}-${repo_name}
# TODO submodule 문제??
repo:
  backend:
    url: http://github.com/ScriptonBasestar/dripter-backend.git
    branch: master
    reset_command:
      - git fetch origin
      - git clean -dfx
      - git
  
  admin:
    url: http://github.com/ScriptonBasestar/dripter-admin.git
    branch: master
    reset_command:
      - git fetch origin
      - git clean -dfx
      - git

  frontend:
    url: http://github.com/ScriptonBasestar/dripter-front.git
    branch: master
    reset_command:
      - git fetch origin
      - git clean -dfx
      - git

bulid_phase:
  kos_backend:
    context:
      arg:
        - JDK_VERSION=1.8
        - GRADLE_VERSION=4.9
      dockerfile: MinG.Build.Dockerfile
    env:
      - USER_HOME=/home/ubuntu
    repo: #최초로 실행. volume을 이용. copy_in으로 하면 비효율.. volume 중복ㅇ로 인한 문제는 확인필요. 안되면 copy_in
      - backend:/application/backend
      - frontend:/application/admin
    volume:
#      - {name}:{mount_path:if not defined use default}
      - npm:/application/backend/npm_modules
#      admin도 npm이 필요한데 이 경우는 copy_in이용. 어거지로 repo 두개 쓰는 샘플 만들다보니 생긴 사고
#      - npm:/application/admin/npm_modules
      - m2
#      - m2:/home/ubuntu/.m2
    copy_in:
      - tmp:prepare.sh:/application/prepare.sh
      - npm:.:/application/admin/npm_modules
    exec:
      - work_root: /application/backend
        command:
          - gradle clean
          - gradle yarn
          - gradle build
      - work_root: /application/admin
        command:
          - gradle clean
          - gradle yarn
          - gradle build
    copy_out:
      - /application/backend/app/build/libs/backend.jar:pass_jar:/backend.jar
      - /application/admin/app/build/libs/admin.jar:pass_jar:/admin.jar

  kos_front:
    depends_on: kos_backend
    context:
      image_name: nodejs:8
    env:
      - USER_HOME=/home/ubuntu
    repo:
      - frontend:/application
    volume:
      - npm_g
      - npm:/application/npm_modules
    exec:
      - work_root: /application
        command:
          - yarn install
    copy_out:
      - /application/.:pass_front:/
#    entrypoint: build.sh
```

deploy
```yaml
deploy_phase:
  # 도커 이미지 업로드
  # jar 업로드. ssh ...등등 이런건 여기서 신경 쓸 포인트가 아님
  
  # 이미지 배포
  deploy_backend:
    depends_on:
      - kos_backend
      - kos_frontend
    context:
      dockerimage: openjdk:8-alpine
    copy_in:
      - pass_jar:backend.jar:/application/app.jar
    env:
      - USER_HOME=/home/ubuntu
      - SPRING_PROVILES_ACTIVE=prd
      - DB0_HOST=localhost
      - DB0_USERNAME=enc("mysql_username")
      - DB0_PASSWORD=enc("mysql_password")
      - REDIS_SECRET=enc("redis_secret")
    entrypoint: java -jar ~~~
    # TODO 보통... 인증 필요
    push_to: [scriptonbasestar/deploy_backend:latest]

  # jar 배포 TODO 아직 없음
#  deploy_admin:
#    depends_on:
#      - kos_backend
#    ????
  
  deploy_kos_frontend:
    depends_on:
      - kos_frontend
    context:
      dockerimage: nodejs:8-alpine
    copy_in:
      - pass_front:/:/application/
    env:
      - USER_HOME=/home/ubuntu
      - NODE_ENV=prd
      - BACKEND_HOST=nameofbackendservice
      - REDIS_SECRET=enc("redis_secret")
    entrypoint: npm server
    push_to: [scriptonbasestar/deploy_frontend:latest]
```

#### box 만들어놓고 사용
초기 지원할 box 목록 github에 등록
1. vcs
2. gradle
3. openjdk8
4. command
```
box type vcs git
box type build
box type deploy
box type deploy2
```
